// Prisma Schema for Punsook Lotto System
// ระบบคีย์หวยสำหรับเจ้ามือ

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================
// USER MANAGEMENT & ROLES
// =============================================

// Role ระบบ - กำหนดสิทธิ์การเข้าถึงเมนู
model Role {
  id          String   @id @default(cuid())
  code        String   @unique // MASTER, ADMIN, OPERATOR, VIEWER
  name        String   // ชื่อแสดง
  description String?
  permissions String   // JSON array of permission codes
  isSystem    Boolean  @default(false) // true = ไม่สามารถลบได้
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]
}

model User {
  id                String   @id @default(cuid())
  username          String   @unique
  password          String
  name              String
  email             String?
  phone             String?
  roleId            String
  customPermissions Json?    // สิทธิ์กำหนดเอง (แทนที่ Role permissions)
  isActive          Boolean  @default(true)
  lastLogin         DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  role       Role          @relation(fields: [roleId], references: [id])
  bets       Bet[]
  layoffs    Layoff[]
  activities ActivityLog[]

  @@index([roleId])
  @@index([isActive])
}

// =============================================
// AGENT MANAGEMENT
// =============================================

model Agent {
  id        String   @id @default(cuid())
  code      String   @unique // รหัส Agent เช่น A001
  name      String
  phone     String?
  note      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  discounts       AgentDiscount[]
  payRates        AgentPayRate[]
  quotas          AgentQuota[]
  bets            Bet[]
  betSessions     BetSession[]
  discountPresets DiscountPreset[]

  @@index([isActive])
  @@index([createdAt])
}

// Discount Preset - รูปแบบส่วนลดของ Agent ต่อประเภทหวย (Master กำหนด)
model DiscountPreset {
  id          String   @id @default(cuid())
  agentId     String
  lotteryType String   // THAI, LAO, HANOI
  name        String   // ชื่อ Preset เช่น "VIP", "Premium", "ลูกค้าประจำ"
  discount    Float    @default(0) // % ส่วนลด (ใช้กับทุกประเภทการแทง)
  isFullPay   Boolean  @default(false) // จ่ายเต็ม (ไม่ลด%, ถูกเลขอั้นก็จ่ายเต็ม)
  isDefault   Boolean  @default(false) // เป็น preset หลัก
  isActive    Boolean  @default(true)
  payRates    Json?    // อัตราจ่ายพิเศษ เช่น { "THREE_TOP": 850, "TWO_TOP": 85 }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  agent       Agent        @relation(fields: [agentId], references: [id], onDelete: Cascade)
  betSessions BetSession[]

  @@unique([agentId, lotteryType, name])
  @@index([agentId, lotteryType])
  @@index([isDefault])
}

// ส่วนลด Agent แยกตามประเภทหวย
model AgentDiscount {
  id          String   @id @default(cuid())
  agentId     String
  lotteryType String   // THAI, LAO, HANOI
  discount    Float    @default(0) // % ส่วนลด
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, lotteryType])
}

// อัตราจ่ายเฉพาะ Agent (ถ้าไม่ตั้งจะใช้อัตราจ่ายกลาง)
model AgentPayRate {
  id          String   @id @default(cuid())
  agentId     String
  lotteryType String   // THAI, LAO, HANOI
  betType     String   // THREE_TOP, THREE_TOD, TWO_TOP, TWO_BOTTOM, RUN_TOP, RUN_BOTTOM
  payRate     Float    // อัตราจ่ายเฉพาะ Agent นี้
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, lotteryType, betType])
}

// โควต้า Agent แยกตามประเภทหวยและประเภทแทง
model AgentQuota {
  id           String   @id @default(cuid())
  agentId      String
  lotteryType  String   // THAI, LAO, HANOI
  betType      String   // THREE_TOP, THREE_TOD, TWO_TOP, TWO_BOTTOM, RUN_TOP, RUN_BOTTOM
  quotaAmount  Float    @default(500) // โควต้าต่อเลข
  allowDynamic Boolean  @default(true) // อนุญาตเกินโควต้าถ้า Global เหลือ
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([agentId, lotteryType, betType])
}

// =============================================
// LOTTERY SETTINGS
// =============================================

// ประเภทหวย
model LotteryType {
  id           String   @id @default(cuid())
  code         String   @unique // THAI, LAO, HANOI
  name         String   // หวยไทย, หวยลาว, หวยฮานอย
  description  String?
  drawDays     String?  // วันออกผล เช่น "1,16" หรือ "MON,WED,FRI"
  openTime     String?  // เวลาเปิดรับ เช่น "00:00"
  closeTime    String?  // เวลาปิดรับ เช่น "14:30"
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  payRates     PayRate[]
  globalLimits GlobalLimit[]
  rounds       LotteryRound[]
}

// อัตราจ่าย
model PayRate {
  id            String   @id @default(cuid())
  lotteryTypeId String
  betType       String   // THREE_TOP, THREE_TOD, TWO_TOP, TWO_BOTTOM, RUN_TOP, RUN_BOTTOM
  payRate       Float    // อัตราจ่าย เช่น 900, 150, 90
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lotteryType LotteryType @relation(fields: [lotteryTypeId], references: [id], onDelete: Cascade)

  @@unique([lotteryTypeId, betType])
}

// Global Limit ต่อเลข
model GlobalLimit {
  id            String   @id @default(cuid())
  lotteryTypeId String
  betType       String   // THREE_TOP, THREE_TOD, TWO_TOP, TWO_BOTTOM, RUN_TOP, RUN_BOTTOM
  limitAmount   Float    // Limit รวมต่อเลข
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lotteryType LotteryType @relation(fields: [lotteryTypeId], references: [id], onDelete: Cascade)

  @@unique([lotteryTypeId, betType])
}

// =============================================
// CAPITAL & RISK MANAGEMENT
// =============================================

// ตั้งค่าทุน
model CapitalSetting {
  id             String   @id @default(cuid())
  totalCapital   Float    // ทุนทั้งหมด
  riskMode       String   @default("BALANCED") // CONSERVATIVE, BALANCED, AGGRESSIVE, CUSTOM
  riskPercentage Float    @default(75) // % ที่ใช้
  usableCapital  Float    // ทุนที่ใช้ได้ = total × risk%
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// =============================================
// LOTTERY ROUNDS
// =============================================

model LotteryRound {
  id            String    @id @default(cuid())
  lotteryTypeId String
  roundDate     DateTime  // วันที่งวด
  status        String    @default("OPEN") // OPEN, CLOSED, RESULTED
  result3Top    String?   // ผล 3 ตัวบน
  result3Tod    String?   // ผล 3 ตัวโต๊ด (comma separated)
  result2Top    String?   // ผล 2 ตัวบน
  result2Bottom String?   // ผล 2 ตัวล่าง
  closedAt      DateTime?
  resultedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  lotteryType  LotteryType         @relation(fields: [lotteryTypeId], references: [id])
  bets         Bet[]
  restrictions NumberRestriction[]
  layoffs      Layoff[]

  @@unique([lotteryTypeId, roundDate])
  @@index([status])
  @@index([roundDate])
  @@index([lotteryTypeId, status])
}

// =============================================
// BETTING
// =============================================

model BetSession {
  id               String   @id @default(cuid())
  agentId          String
  discountPresetId String?  // Preset ที่เลือกใช้
  note             String?
  createdAt        DateTime @default(now())

  agent          Agent           @relation(fields: [agentId], references: [id])
  discountPreset DiscountPreset? @relation(fields: [discountPresetId], references: [id])
  bets           Bet[]

  @@index([agentId])
  @@index([createdAt])
  @@index([note])
}

model Bet {
  id            String   @id @default(cuid())
  sessionId     String?
  agentId       String
  roundId       String
  number        String   // เลขที่แทง
  betType       String   // THREE_TOP, THREE_TOD, TWO_TOP, TWO_BOTTOM, RUN_TOP, RUN_BOTTOM
  amount        Float    // ยอดแทง
  discountPct   Float    @default(0) // % ส่วนลด ณ ขณะแทง
  discountAmt   Float    @default(0) // จำนวนส่วนลด
  netAmount     Float    // ยอดสุทธิหลังหักส่วนลด
  payRate       Float    // อัตราจ่าย ณ ขณะแทง
  isFullPay     Boolean  @default(false) // จ่ายเต็ม (ไม่สนเลขอั้น)
  isWin         Boolean?
  winAmount     Float?   // ยอดถูกรางวัล
  status        String   @default("ACTIVE") // ACTIVE, CANCELLED, WON, LOST
  createdById   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Cancel/Edit tracking
  cancelledAt   DateTime?
  cancelledBy   String?
  cancelReason  String?

  session   BetSession?  @relation(fields: [sessionId], references: [id])
  agent     Agent        @relation(fields: [agentId], references: [id])
  round     LotteryRound @relation(fields: [roundId], references: [id])
  createdBy User?        @relation(fields: [createdById], references: [id])

  // Indexes for common queries
  @@index([roundId])
  @@index([agentId])
  @@index([sessionId])
  @@index([status])
  @@index([createdAt])
  @@index([number, betType])
  @@index([roundId, status])
  @@index([agentId, status])
  @@index([roundId, number, betType])
}

// =============================================
// NUMBER RESTRICTIONS (เลขอั้น)
// =============================================

model NumberRestriction {
  id              String   @id @default(cuid())
  roundId         String
  number          String   // เลขที่อั้น
  betType         String   // ประเภทที่อั้น
  restrictionType String   // BLOCKED, REDUCED_LIMIT, REDUCED_PAYOUT
  value           Float?   // limit หรือ payout rate ใหม่
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  round LotteryRound @relation(fields: [roundId], references: [id], onDelete: Cascade)

  @@unique([roundId, number, betType])
  @@index([roundId])
}

// =============================================
// LAY OFF (ตีออก)
// =============================================

model Layoff {
  id           String    @id @default(cuid())
  roundId      String
  number       String
  betType      String
  totalAmount  Float     // ยอดรับรวม
  limitAmount  Float     // Limit ที่รับได้
  excessAmount Float     // ยอดเกิน = total - limit
  layoffAmount Float     // ยอดที่ตีออก
  keepAmount   Float     // ยอดที่เก็บเอง
  status       String    @default("PENDING") // PENDING, EXPORTED, SENT, CONFIRMED
  sentTo       String?   // เจ้าที่ส่งให้
  note         String?
  exportedAt   DateTime?
  confirmedAt  DateTime?
  createdById  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  round     LotteryRound @relation(fields: [roundId], references: [id])
  createdBy User?        @relation(fields: [createdById], references: [id])

  @@index([roundId])
  @@index([status])
  @@index([roundId, status])
}

// =============================================
// ACTIVITY LOG
// =============================================

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String   // LOGIN, LOGOUT, CREATE_BET, CANCEL_BET, etc.
  entityType String?  // Agent, Bet, Round, etc.
  entityId   String?
  details    String?  // JSON string for additional details
  ipAddress  String?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])
}
